{{define "content"}}
<!-- Filter Bar -->
<div class="card" style="margin-bottom: 1rem;">
    <form id="security-filter-form" hx-get="/api/security" hx-target="#sec-tab-content" hx-trigger="change" hx-swap="innerHTML">
        <input type="hidden" name="range" id="sec-range-input" value="{{.Range}}">
        <input type="hidden" name="tab" id="sec-tab-input" value="{{.ActiveTab}}">
        <input type="hidden" name="custom_from" id="sec-custom-from-hidden" value="{{.CustomFrom}}">
        <input type="hidden" name="custom_to" id="sec-custom-to-hidden" value="{{.CustomTo}}">

        <div class="filter-bar">
            <div style="display: flex; gap: 5px;">
                <button type="button" class="filter-btn {{if eq .Range "today"}}active{{end}}" onclick="setSecRange(this, 'today')">Today</button>
                <button type="button" class="filter-btn {{if eq .Range "7d"}}active{{end}}" onclick="setSecRange(this, '7d')">7 Days</button>
                <button type="button" class="filter-btn {{if eq .Range "30d"}}active{{end}}" onclick="setSecRange(this, '30d')">30 Days</button>
                <button type="button" class="filter-btn {{if eq .Range "custom"}}active{{end}}" onclick="setSecRange(this, 'custom')">Custom</button>
            </div>

            <div id="sec-custom-dates" style="display: {{if eq .Range "custom"}}flex{{else}}none{{end}}; gap: 5px; align-items: center;">
                <input type="date" id="sec-custom-from" value="{{if .CustomFrom}}{{.CustomFrom}}{{else}}{{formatDate -7}}{{end}}" onchange="updateSecCustomDates()">
                <span class="text-secondary">to</span>
                <input type="date" id="sec-custom-to" value="{{if .CustomTo}}{{.CustomTo}}{{else}}{{formatDate 0}}{{end}}" onchange="updateSecCustomDates()">
            </div>
        </div>
    </form>
</div>

<!-- Tab Bar -->
<div class="tab-list" style="margin-bottom: 1rem;">
    <button class="tab {{if eq .ActiveTab "summary"}}tab-active{{end}}" onclick="switchSecTab(this, 'summary')">Summary</button>
    <button class="tab {{if eq .ActiveTab "errors"}}tab-active{{end}}" onclick="switchSecTab(this, 'errors')">Errors</button>
    <button class="tab {{if eq .ActiveTab "performance"}}tab-active{{end}}" onclick="switchSecTab(this, 'performance')">Performance</button>
</div>

<!-- Tab Content (swappable via htmx) -->
<div id="sec-tab-content" class="loading-bar" hx-indicator=".sec-loading-indicator">
    <div class="htmx-indicator loading-bar-indicator sec-loading-indicator"></div>
    {{template "security_tab_summary.html" .}}
</div>
<div class="last-updated" x-data="{ ago: '' }" x-init="
    let ts = Date.now();
    setInterval(() => { let s = Math.round((Date.now() - ts) / 1000); ago = s < 5 ? 'just now' : s + 's ago'; }, 1000);
    document.body.addEventListener('htmx:afterSettle', (e) => { if (e.detail.target && e.detail.target.id === 'sec-tab-content') { ts = Date.now(); ago = 'just now'; } });
" x-text="'Updated ' + ago"></div>

<script>
function switchSecTab(btn, tab) {
    document.getElementById('sec-tab-input').value = tab;
    document.querySelectorAll('.tab-list .tab').forEach(function(t) { t.classList.remove('tab-active'); });
    btn.classList.add('tab-active');
    htmx.ajax('GET', '/api/security?' + new URLSearchParams(new FormData(document.getElementById('security-filter-form'))).toString(), {target: '#sec-tab-content', swap: 'innerHTML'});
}

function setSecRange(btn, val) {
    document.getElementById('sec-range-input').value = val;
    document.querySelectorAll('#security-filter-form .filter-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');

    var customDates = document.getElementById('sec-custom-dates');
    if (val === 'custom') {
        customDates.style.display = 'flex';
        updateSecCustomDates();
    } else {
        customDates.style.display = 'none';
        document.getElementById('sec-custom-from-hidden').value = '';
        document.getElementById('sec-custom-to-hidden').value = '';
    }
    htmx.ajax('GET', '/api/security?' + new URLSearchParams(new FormData(document.getElementById('security-filter-form'))).toString(), {target: '#sec-tab-content', swap: 'innerHTML'});
}

function updateSecCustomDates() {
    document.getElementById('sec-custom-from-hidden').value = document.getElementById('sec-custom-from').value;
    document.getElementById('sec-custom-to-hidden').value = document.getElementById('sec-custom-to').value;
}
</script>
{{end}}
