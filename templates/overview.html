{{define "content"}}
<!-- Filter Bar -->
<div class="card" style="margin-bottom: 1rem;">
    <form id="filter-form" hx-get="/api/overview" hx-target="#tab-content" hx-trigger="change" hx-swap="innerHTML">
        <input type="hidden" name="range" id="range-input" value="{{.Range}}">
        <input type="hidden" name="tab" id="tab-input" value="{{.ActiveTab}}">
        <input type="hidden" name="custom_from" id="custom-from-hidden" value="{{.CustomFrom}}">
        <input type="hidden" name="custom_to" id="custom-to-hidden" value="{{.CustomTo}}">

        <div class="filter-bar">
            <!-- Date Range buttons -->
            <div style="display: flex; gap: 5px;">
                <button type="button" class="filter-btn {{if eq .Range "today"}}active{{end}}" onclick="setRange(this, 'today')">Today</button>
                <button type="button" class="filter-btn {{if eq .Range "7d"}}active{{end}}" onclick="setRange(this, '7d')">7 Days</button>
                <button type="button" class="filter-btn {{if eq .Range "30d"}}active{{end}}" onclick="setRange(this, '30d')">30 Days</button>
                <button type="button" class="filter-btn {{if eq .Range "custom"}}active{{end}}" onclick="setRange(this, 'custom')">Custom</button>
            </div>

            <!-- Custom date inputs -->
            <div id="custom-dates" style="display: {{if eq .Range "custom"}}flex{{else}}none{{end}}; gap: 5px; align-items: center;">
                <input type="date" id="custom-from" value="{{if .CustomFrom}}{{.CustomFrom}}{{else}}{{formatDate -7}}{{end}}" onchange="updateCustomDates()">
                <span style="color: var(--text-secondary);">to</span>
                <input type="date" id="custom-to" value="{{if .CustomTo}}{{.CustomTo}}{{else}}{{formatDate 0}}{{end}}" onchange="updateCustomDates()">
            </div>

            <!-- Router selector -->
            <select name="router">
                <option value="">All Services</option>
                {{range .Routers}}
                <option value="{{.}}" {{if eq . $.Router}}selected{{end}}>{{.}}</option>
                {{end}}
            </select>

            <!-- Bot toggle -->
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" name="bots" value="true" {{if .IncludeBots}}checked{{end}}>
                Include bots
            </label>
        </div>
    </form>
</div>

<!-- Tab Bar -->
<div class="tab-list" style="margin-bottom: 1rem;">
    <button class="tab {{if eq .ActiveTab "summary"}}tab-active{{end}}" onclick="switchTab(this, 'summary')">Summary</button>
    <button class="tab {{if eq .ActiveTab "traffic"}}tab-active{{end}}" onclick="switchTab(this, 'traffic')">Traffic</button>
    <button class="tab {{if eq .ActiveTab "status"}}tab-active{{end}}" onclick="switchTab(this, 'status')">Status</button>
    <button class="tab {{if eq .ActiveTab "devices"}}tab-active{{end}}" onclick="switchTab(this, 'devices')">Devices</button>
    <button class="tab {{if eq .ActiveTab "performance"}}tab-active{{end}}" onclick="switchTab(this, 'performance')">Performance</button>
</div>

<!-- Tab Content (swappable via htmx) -->
<div id="tab-content">
    {{template "overview_tab_summary.html" .}}
</div>

<script>
function switchTab(btn, tab) {
    document.getElementById('tab-input').value = tab;
    document.querySelectorAll('.tab-list .tab').forEach(function(t) { t.classList.remove('tab-active'); });
    btn.classList.add('tab-active');
    htmx.ajax('GET', '/api/overview?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target: '#tab-content', swap: 'innerHTML'});
}

function setRange(btn, val) {
    document.getElementById('range-input').value = val;
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    var customDates = document.getElementById('custom-dates');
    if (val === 'custom') {
        customDates.style.display = 'flex';
        updateCustomDates();
    } else {
        customDates.style.display = 'none';
        document.getElementById('custom-from-hidden').value = '';
        document.getElementById('custom-to-hidden').value = '';
    }
    htmx.ajax('GET', '/api/overview?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target: '#tab-content', swap: 'innerHTML'});
}

function updateCustomDates() {
    document.getElementById('custom-from-hidden').value = document.getElementById('custom-from').value;
    document.getElementById('custom-to-hidden').value = document.getElementById('custom-to').value;
}

// Auto-refresh every 30s
setInterval(function() {
    htmx.ajax('GET', '/api/overview?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target: '#tab-content', swap: 'innerHTML'});
}, 30000);

// Drilldown toggle
document.addEventListener('click', function(evt) {
    var trigger = evt.target.closest('.drilldown-trigger');
    if (!trigger) return;
    var row = trigger.nextElementSibling;
    if (row && row.classList.contains('drilldown-row')) {
        if (row.style.display !== 'none' && row.querySelector('.drilldown-content')) {
            row.style.display = 'none';
            return;
        }
    }
});
</script>
{{end}}
